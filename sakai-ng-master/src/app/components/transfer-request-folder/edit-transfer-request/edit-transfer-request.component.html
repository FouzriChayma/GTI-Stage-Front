<div class="transfer-request-container">
  <p-toast></p-toast>
  
  <!-- Header Section -->
  <div class="form-header">
    <h1 class="form-title">Edit Transfer Request</h1>
    <p class="form-subtitle">Update the transfer request details and save your changes</p>
  </div>

  <form class="p-fluid" *ngIf="!loading && transferRequest">
    <!-- Account Information Section -->
    <div class="form-section account-section">
      <h2 class="section-title account-info">Account Information</h2>
      <div class="grid">
        <div class="field col-12 lg:col-4">
          <label for="userId" class="required">User ID</label>
          <input
            type="number"
            pInputText
            id="userId"
            [(ngModel)]="transferRequest.userId"
            name="userId"
            required
            min="1"
            class="modern-input"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.userId">
            User ID is required and must be positive.
          </small>
        </div>

        <div class="field col-12 lg:col-4">
          <label for="commissionAccountNumber" class="required">Commission Account</label>
          <input
            type="text"
            pInputText
            id="commissionAccountNumber"
            [(ngModel)]="transferRequest.commissionAccountNumber"
            name="commissionAccountNumber"
            required
            class="modern-input"
            placeholder="Enter account number"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.commissionAccountNumber?.trim()">
            Commission Account is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.commissionAccountNumber && (transferRequest.commissionAccountNumber.length < 10 || transferRequest.commissionAccountNumber.length > 34)">
            Commission Account must be 10-34 characters.
          </small>
        </div>

        <div class="field col-12 lg:col-4">
          <label for="commissionAccountType" class="required">Commission Type</label>
          <p-dropdown
            [(ngModel)]="transferRequest.commissionAccountType"
            [options]="accountTypes"
            optionLabel="label"
            optionValue="value"
            name="commissionAccountType"
            placeholder="Select Type"
            required
            class="modern-dropdown"
          ></p-dropdown>
          <small class="p-error" *ngIf="submitted && !transferRequest.commissionAccountType">
            Commission Account Type is required.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="settlementAccountNumber" class="required">Settlement Account</label>
          <input
            type="text"
            pInputText
            id="settlementAccountNumber"
            [(ngModel)]="transferRequest.settlementAccountNumber"
            name="settlementAccountNumber"
            required
            class="modern-input"
            placeholder="Enter settlement account"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.settlementAccountNumber?.trim()">
            Settlement Account is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.settlementAccountNumber && (transferRequest.settlementAccountNumber.length < 10 || transferRequest.settlementAccountNumber.length > 34)">
            Settlement Account must be 10-34 characters.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="settlementAccountType" class="required">Settlement Type</label>
          <p-dropdown
            [(ngModel)]="transferRequest.settlementAccountType"
            [options]="accountTypes"
            optionLabel="label"
            optionValue="value"
            name="settlementAccountType"
            placeholder="Select Type"
            required
            class="modern-dropdown"
          ></p-dropdown>
          <small class="p-error" *ngIf="submitted && !transferRequest.settlementAccountType">
            Settlement Account Type is required.
          </small>
        </div>
      </div>
    </div>

    <!-- Transfer Details Section -->
    <div class="form-section transfer-section">
      <h2 class="section-title transfer-details">Transfer Details</h2>
      <div class="grid">
        <div class="field col-12 lg:col-3">
          <label for="transferType" class="required">Transfer Type</label>
          <p-dropdown
            [(ngModel)]="transferRequest.transferType"
            [options]="transferTypes"
            optionLabel="label"
            optionValue="value"
            name="transferType"
            placeholder="Select Type"
            required
            class="modern-dropdown"
          ></p-dropdown>
          <small class="p-error" *ngIf="submitted && !transferRequest.transferType">
            Transfer Type is required.
          </small>
        </div>

        <div class="field col-12 lg:col-3">
          <label for="issueDate" class="required">Issue Date</label>
          <input
            type="date"
            pInputText
            id="issueDate"
            [(ngModel)]="transferRequest.issueDate"
            name="issueDate"
            required
            class="modern-input"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.issueDate">
            Issue Date is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.issueDate && isFutureDate(transferRequest.issueDate)">
            Issue Date cannot be in the future.
          </small>
        </div>

        <div class="field col-12 lg:col-3">
          <label for="currency" class="required">Currency</label>
          <input
            type="text"
            pInputText
            id="currency"
            [(ngModel)]="transferRequest.currency"
            name="currency"
            required
            pattern="[A-Z]{3}"
            class="modern-input"
            placeholder="TND"
            maxlength="3"
          />
          <small class="p-error" *ngIf="submitted && !isCurrencyValid(transferRequest.currency)">
            Currency must be a 3-letter ISO 4217 code (e.g., TND, USD).
          </small>
        </div>

        <div class="field col-12 lg:col-3">
          <label for="amount" class="required">Amount</label>
          <p-inputNumber
            id="amount"
            [(ngModel)]="transferRequest.amount"
            mode="decimal"
            [min]="0.001"
            [maxFractionDigits]="3"
            name="amount"
            required
            class="modern-input-number"
            placeholder="0.000"
          ></p-inputNumber>
          <small class="p-error" *ngIf="submitted && !transferRequest.amount">
            Amount is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.amount <= 0.001">
            Amount must be greater than 0.001.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="feeType" class="required">Fee Type</label>
          <p-dropdown
            [(ngModel)]="transferRequest.feeType"
            [options]="feeTypes"
            optionLabel="label"
            optionValue="value"
            name="feeType"
            placeholder="Select Fee Type"
            required
            class="modern-dropdown"
          ></p-dropdown>
          <small class="p-error" *ngIf="submitted && !transferRequest.feeType">
            Fee Type is required.
          </small>
        </div>
      </div>

      <!-- Commercial Transfer Fields -->
      <div class="commercial-fields" *ngIf="transferRequest.transferType === 'COMMERCIAL'">
        <h3 class="section-title commercial-info">Commercial Transfer Details</h3>
        <div class="grid">
          <div class="field col-12 lg:col-4">
            <label for="invoiceNumber" class="required">Invoice Number</label>
            <input
              type="text"
              pInputText
              id="invoiceNumber"
              [(ngModel)]="transferRequest.invoiceNumber"
              name="invoiceNumber"
              required
              class="modern-input"
              placeholder="Enter invoice number"
            />
            <small class="p-error" *ngIf="submitted && transferRequest.transferType === 'COMMERCIAL' && !transferRequest.invoiceNumber?.trim()">
              Invoice Number is required for Commercial transfers.
            </small>
            <small class="p-error" *ngIf="submitted && transferRequest.invoiceNumber && transferRequest.invoiceNumber.length > 50">
              Invoice Number must not exceed 50 characters.
            </small>
          </div>

          <div class="field col-12 lg:col-4">
            <label for="invoiceDate" class="required">Invoice Date</label>
            <input
              type="date"
              pInputText
              id="invoiceDate"
              [(ngModel)]="transferRequest.invoiceDate"
              name="invoiceDate"
              required
              class="modern-input"
            />
            <small class="p-error" *ngIf="submitted && transferRequest.transferType === 'COMMERCIAL' && !transferRequest.invoiceDate">
              Invoice Date is required for Commercial transfers.
            </small>
            <small class="p-error" *ngIf="submitted && transferRequest.invoiceDate && isFutureDate(transferRequest.invoiceDate)">
              Invoice Date cannot be in the future.
            </small>
          </div>

          <div class="field col-12 lg:col-4">
            <label for="transferReason" class="required">Transfer Reason</label>
            <input
              type="text"
              pInputText
              id="transferReason"
              [(ngModel)]="transferRequest.transferReason"
              name="transferReason"
              required
              class="modern-input"
              placeholder="Enter transfer reason"
            />
            <small class="p-error" *ngIf="submitted && transferRequest.transferType === 'COMMERCIAL' && !transferRequest.transferReason?.trim()">
              Transfer Reason is required for Commercial transfers.
            </small>
            <small class="p-error" *ngIf="submitted && transferRequest.transferReason && transferRequest.transferReason.length > 255">
              Transfer Reason must not exceed 255 characters.
            </small>
          </div>
        </div>
      </div>

      <!-- Transfer Options -->
      <div class="options-section">
        <h3 class="section-title options-info">Transfer Options</h3>
        <div class="grid">
          <div class="field col-12 lg:col-4">
            <div class="checkbox-wrapper">
              <p-checkbox
                [(ngModel)]="transferRequest.isNegotiation"
                name="isNegotiation"
                binary="true"
                class="modern-checkbox"
              ></p-checkbox>
              <label for="isNegotiation" class="checkbox-label">Negotiation Required</label>
            </div>
          </div>

          <div class="field col-12 lg:col-4">
            <div class="checkbox-wrapper">
              <p-checkbox
                [(ngModel)]="transferRequest.isTermNegotiation"
                name="isTermNegotiation"
                binary="true"
                class="modern-checkbox"
              ></p-checkbox>
              <label for="isTermNegotiation" class="checkbox-label">Term Negotiation</label>
            </div>
          </div>

          <div class="field col-12 lg:col-4">
            <div class="checkbox-wrapper">
              <p-checkbox
                [(ngModel)]="transferRequest.isFinancing"
                name="isFinancing"
                binary="true"
                class="modern-checkbox"
              ></p-checkbox>
              <label for="isFinancing" class="checkbox-label">Financing Required</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Beneficiary Information Section -->
    <div class="form-section beneficiary-section">
      <h2 class="section-title beneficiary-info">Beneficiary Information</h2>
      <div class="grid">
        <div class="field col-12 lg:col-6">
          <label for="beneficiaryName" class="required">Beneficiary Name</label>
          <input
            type="text"
            pInputText
            id="beneficiaryName"
            [(ngModel)]="transferRequest.beneficiary.name"
            name="beneficiaryName"
            required
            class="modern-input"
            placeholder="Enter full name"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.beneficiary.name?.trim()">
            Beneficiary name is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.beneficiary.name && transferRequest.beneficiary.name.length > 100">
            Beneficiary name must not exceed 100 characters.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="beneficiaryCountry" class="required">Country</label>
          <input
            type="text"
            pInputText
            id="beneficiaryCountry"
            [(ngModel)]="transferRequest.beneficiary.country"
            name="beneficiaryCountry"
            required
            class="modern-input"
            placeholder="Enter country"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.beneficiary.country?.trim()">
            Country is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.beneficiary.country && transferRequest.beneficiary.country.length > 100">
            Country must not exceed 100 characters.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="destinationBank" class="required">Destination Bank</label>
          <input
            type="text"
            pInputText
            id="destinationBank"
            [(ngModel)]="transferRequest.beneficiary.destinationBank"
            name="destinationBank"
            required
            class="modern-input"
            placeholder="Enter bank name"
          />
          <small class="p-error" *ngIf="submitted && !transferRequest.beneficiary.destinationBank?.trim()">
            Destination bank is required.
          </small>
          <small class="p-error" *ngIf="submitted && transferRequest.beneficiary.destinationBank && transferRequest.beneficiary.destinationBank.length > 100">
            Destination bank must not exceed 100 characters.
          </small>
        </div>

        <div class="field col-12 lg:col-6">
          <label for="bankAccount">Bank Account Number</label>
          <input
            type="text"
            pInputText
            id="bankAccount"
            [(ngModel)]="transferRequest.beneficiary.bankAccount"
            name="bankAccount"
            class="modern-input"
            placeholder="Enter account number (optional)"
          />
          <small class="p-error" *ngIf="submitted && transferRequest.beneficiary.bankAccount && transferRequest.beneficiary.bankAccount.length > 34">
            Bank Account must not exceed 34 characters.
          </small>
        </div>
      </div>
    </div>

    <!-- Documents Section -->
    <div class="form-section documents-section">
      <h2 class="section-title documents">Supporting Documents</h2>
      
      <!-- Existing Documents -->
      <div class="field col-12">
        <h3>Existing Documents</h3>
        <p-table [value]="transferRequest.documents || []" [tableStyle]="{'min-width': '50rem'}" *ngIf="(transferRequest.documents?.length || 0) > 0">
          <ng-template pTemplate="header">
            <tr>
              <th>File Name</th>
              <th>File Type</th>
              <th>Upload Date</th>
              <th>Action</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-document>
            <tr>
              <td>{{ document.fileName }}</td>
              <td>{{ document.fileType }}</td>
              <td>{{ document.uploadDate | date:'medium' }}</td>
              <td>
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-danger p-button-sm"
                  (click)="deleteDocument(document.idDocument)"
                  [disabled]="isSaving"
                ></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <p *ngIf="(transferRequest.documents?.length || 0) === 0">No documents available.</p>
      </div>

      <!-- Upload New Documents -->
      <div class="field col-12">
        <label for="documents">Upload Additional Documents (Optional)</label>
        <!-- [auto]="false" disables auto upload -->
        <!-- [showUploadButton]="false" hides the Upload button -->
        <!-- [showCancelButton]="false" hides the Cancel button -->
        <p-fileUpload
          name="documents"
          [multiple]="true"
          accept="image/png,image/jpeg,application/pdf"
          (onSelect)="onFileSelected($event)"
          chooseLabel="Browse Files"
          [maxFileSize]="10000000"
          [auto]="false"
          [showUploadButton]="false"
          [showCancelButton]="false"
          class="modern-file-upload"
        ></p-fileUpload>
        <small class="file-info">Supported formats: PDF, PNG, JPEG (Max 10MB each)</small>
      </div>
    </div>
  </form>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-content">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: #3b82f6;"></i>
      <p>Loading transfer request...</p>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons" *ngIf="!loading && transferRequest">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      (click)="router.navigate(['/transfer-requests'])"
      styleClass="p-button-outlined p-button-secondary"
      class="cancel-btn"
    ></p-button>
    
    <p-button
      label="Update Transfer Request"
      icon="pi pi-check"
      (click)="updateTransferRequest()"
      [loading]="isSaving"
      styleClass="p-button-primary"
      class="submit-btn"
    ></p-button>
  </div>
</div>